\begin{question}
  (Chapter 4, Problem 2.1) Suppose that \( X \mid p \sim \mathrm{Bin}(n, p) \), and the family of prior distributions for \( p \) is the family of beta distributions \( \mathrm{Beta}(a,b) \).
\end{question}

\begin{parts}
  \part Show that the marginal distribution of \( X \) is the \textit{beta-binomial} distribution with mass function
  \[
    \binom{n}{x} \frac{\Gamma(a+b)}{\Gamma(a)\Gamma(b)} \frac{\Gamma(x+a)\Gamma(n-x+b)}{\Gamma(n+a+b)}.
  \]

  \begin{solution}
    To find the marginal distribution of \( X \),
    \[
      \begin{aligned}
         &  & \Pr(X = x) & = \int_{0}^{1} \Pr(X = x \mid  p) f(p)\, dp                                                                                                      \\
         &  &            & =  \frac{\binom{n}{x}}{B(a, b)} B(x + a, n - x + b)\underbrace{\int_{0}^{1} \frac{p^{x+a-1} (1-p)^{n - x + b -1}}{B(x + a, n - x + b)}\, dp}_{1} \\
         &  &            & = \binom{n}{x} \frac{\Gamma(a + b)}{\Gamma(a) \Gamma(b)} \frac{\Gamma(x+a) \Gamma(n-x+b)}{\Gamma(n+a+b)},
      \end{aligned}
    \]
    where the second equality follows because the integrand is the density of \( \mathrm{Beta}(x+a, n-x+b) \), and the last equality follows from the identity
    \[
      B(a, b) = \frac{\Gamma(a) \Gamma(b)}{\Gamma(a + b)}.
    \]
  \end{solution}

  \part Show that the mean and variance of the beta-binomial is given by
  \[
    E(X) = \frac{na}{a+b} \quad \text{and} \quad \mathrm{var}(X) = n \left( \frac{a}{a+b} \right) \left( \frac{b}{a+b} \right)\left( \frac{a+b+n}{a+b+1} \right).
  \]
  [\textit{Hint}: The identities \( E(X) = E[E(X \mid  p)] \) and \( \mathrm{var}(X) = \mathrm{var}[E(X \mid  p)] +\\E[\mathrm{var}(X \mid p)]\) are helpful.]

  \begin{solution}
    As suggested by the hint, from the law of total expectation,
    \[
      E(X) = E[E(X \mid  p)] = E[np] = n E[\mathrm{Beta}(a, b)] = \frac{na}{a+b},
    \]
    and by the law of total variance,
    \begin{align*}
      \mathrm{var}(X) & = \mathrm{var}[E(X \mid p)] + E[\mathrm{var}(X \mid  p)]                \\
                      & = \mathrm{var}(np) + E[np(1-p)]                                         \\
                      & = n^2 \mathrm{var}(p) +  n E(p) - nE(p^2)                               \\
                      & = n^2 \mathrm{var}(p) +  n [E(p) - \mathrm{var}(p) - E^2(p)]            \\
                      & = n [(n-1) \mathrm{var}(p) + E(p)(1 - E(p))]                            \\
                      & = n \left[ (n-1) \frac{ab}{(a+b)^2(a+b+1)} + \frac{ab}{(a+b)^2} \right] \\
                      & = \frac{nab}{(a+b)^2} \left( \frac{n-1}{a+b+1} + 1 \right)              \\
                      & = \frac{nab}{(a+b)^2} \left( \frac{a+b+n}{a+b+1} \right).
    \end{align*}
  \end{solution}
\end{parts}